
#Область Служебные_функции_и_процедуры

&НаКлиенте
// контекст фреймворка Vanessa-Automation
Перем Ванесса;
 
&НаКлиенте
// Структура, в которой хранится состояние сценария между выполнением шагов. Очищается перед выполнением каждого сценария.
Перем Контекст Экспорт;
 
&НаКлиенте
// Структура, в которой можно хранить служебные данные между запусками сценариев. Существует, пока открыта форма Vanessa-Automation.
Перем КонтекстСохраняемый Экспорт;

&НаКлиенте
// Функция экспортирует список шагов, которые реализованы в данной внешней обработке.
Функция ПолучитьСписокТестов(КонтекстФреймворкаBDD) Экспорт
	Ванесса = КонтекстФреймворкаBDD;
	
	ВсеТесты = Новый Массив;

	//описание параметров
	//Ванесса.ДобавитьШагВМассивТестов(ВсеТесты,Снипет,ИмяПроцедуры,ПредставлениеТеста,ОписаниеШага,ТипШага,Транзакция,Параметр);
    Ванесса.ДобавитьШагВМассивТестов(ВсеТесты, "ЯЗагружаюИзСистемыОтката(Парам01)",
		"ЯЗагружаюИзСистемыОтката",
		"И Я Загружаю Из Системы Отката ""ИмяЗакладки""",
		"Загружает из системы отката ищет последнюю закладку по наименованию(ИмяЗакладки). Работает с версии 8.3.6",
		"ТаблоПеременных.ИЯЗагружаюИзСистемыОтката");
	
	Ванесса.ДобавитьШагВМассивТестов(ВсеТесты, "ЯВыгружаюВСистемуОтката(Парам01)",
		"ЯВыгружаюВСистемуОтката",
		"И Я Выгружаю В Систему Отката ""ИмяЗакладки""",
		"Загружает в систему отаката текущее состояние табло с наименованием(ИмяЗакладки). Работает с версии 8.3.6",
		"ТаблоПеременных.ИЯВыгружаюВСистемуОтката");


	Ванесса.ДобавитьШагВМассивТестов(ВсеТесты, "ЯУдаляюИзСистемыОтката(Парам01)",
		"ЯУдаляюИзСистемыОтката",
		"И Я Удаляю Из Системы Отката ""ИмяЗакладки""",
		"Удаляет закладку с наименованием(ИмяЗакладки) из системы отката. Работает с версии 8.3.6",
		"ТаблоПеременных.ИЯУдаляюИзСистемыОтката");


	Ванесса.ДобавитьШагВМассивТестов(ВсеТесты, "ЯЗагружаюИзФайла(Парам01)",
		"ЯЗагружаюИзФайла",
		"И Я Загружаю Из Файла ""ПутьКФайлу""",
		"Загружает из файла",
		"ТаблоПеременных.ИЯЗагружаюИзФайла");     
	
	
	Ванесса.ДобавитьШагВМассивТестов(ВсеТесты, "ЯВыгружаюВФайл(Парам01)",
		"ЯВыгружаюВФайл",
		"И Я Выгружаю В Файл ""ПутьКФайлу""",
		"Выгружает в файл",
		"ТаблоПеременных.ИЯВыгружаюВФайл");
	
	
	

   	Возврат ВсеТесты;
КонецФункции
	
// Делает отключение модуля
Процедура ОтключениеМодуля() Экспорт
	
	Ванесса = Неопределено;
	Контекст = Неопределено;
	КонтекстСохраняемый = Неопределено;
	
КонецПроцедуры
	
&НаСервере
// Служебная функция.
Функция ПолучитьМакетСервер(ИмяМакета)
	ОбъектСервер = РеквизитФормыВЗначение("Объект");
	Возврат ОбъектСервер.ПолучитьМакет(ИмяМакета);
КонецФункции
	
&НаКлиенте
// Служебная функция для подключения библиотеки создания fixtures.
Функция ПолучитьМакетОбработки(ИмяМакета) Экспорт
	Возврат ПолучитьМакетСервер(ИмяМакета);
КонецФункции

#КонецОбласти



#Область Работа_со_сценариями

&НаКлиенте
// Функция выполняется перед началом каждого сценария
Функция ПередНачаломСценария() Экспорт
	
КонецФункции

&НаКлиенте
// Функция выполняется перед окончанием каждого сценария
Функция ПередОкончаниемСценария() Экспорт
	
КонецФункции

#КонецОбласти


///////////////////////////////////////////////////
//Реализация шагов
///////////////////////////////////////////////////





&НаКлиенте
//И я загружаю из системы отката 'ИмяЗакладки'
//@ИЯЗагружаюИзСистемыОтката(Парам01)
Процедура ЯЗагружаюИзСистемыОтката(ИмяЗакладки) Экспорт      
	
	РезультатПоиска = ЗагрузитьИзСистемыОткатаНаСервере(ИмяЗакладки);
    
    Если РезультатПоиска <> Неопределено Тогда
		// Создаем объект для совместимости с функцией ЗагрузитьИзСистемыОтката_ПослеВыбора
		ВыбранныйЭлемент = Новый Структура;
		ВыбранныйЭлемент.Вставить("Значение", РезультатПоиска);
		ВыбранныйЭлемент.Вставить("Представление", РезультатПоиска.Наименование + " (" + Формат(РезультатПоиска.Период, "ДФ=dd.MM.yyyy' 'В=HH:mm:ss") + ")");
		
		Ванесса.ЗагрузитьИзСистемыОтката_ПослеВыбора(ВыбранныйЭлемент,Null);
	КонецЕсли;
	
КонецПроцедуры



	
&НаКлиенте
//И я выгружаю в систему отката 'ИмяЗакладки'
//@ИЯВыгружаюВСистемуОтката(Парам01)
Процедура ЯВыгружаюВСистемуОтката(ИмяЗакладки) Экспорт      
	
	// Проверка доступности системы отката
	Если НЕ ПроверитьДоступностьСистемыОтката() Тогда
		Сообщить("Система отката недоступна. Требуется расширение 'ОткатИзмененийДанных' версии 1.0.0.4 или выше.");
		Возврат;
	КонецЕсли;
	
	Ванесса.ВыгрузитьВСистемуОтката_ПослеВвода(ИмяЗакладки,Null);

КонецПроцедуры


&НаКлиенте
//И я удаляю из системы отката 'ИмяЗакладки'
//@ИЯУдаляюИзСистемыОтката(Парам01)
Процедура ЯУдаляюИзСистемыОтката(ИмяЗакладки) Экспорт      
	
	// Проверка доступности системы отката
	Если НЕ ПроверитьДоступностьСистемыОтката() Тогда
		Сообщить("Система отката недоступна. Требуется расширение 'ОткатИзмененийДанных' версии 1.0.0.4 или выше.");
		Возврат;
	КонецЕсли;
		
	УдалитьПоследнююЗаписьВХранилищеКонтекстов(ИмяЗакладки);
    
КонецПроцедуры


	


&НаКлиенте
//И я загружаю из файла 'ПутьКФайлу'
//@ИЯЗагружаюИзФайла(Параметр1)
Процедура ЯЗагружаюИзФайла(ПутьКФайлу) Экспорт      
	
	// Создаем массив файлов для совместимости с функцией ЗагрузитьПеременныеЗавершение
	ВыбранныеФайлы = Новый Массив;
	ВыбранныеФайлы.Добавить(ПутьКФайлу);
	
	// Создаем пустую структуру для дополнительных параметров
	ДополнительныеПараметры = Новый Структура;
	
	Ванесса.ЗагрузитьПеременныеЗавершение(ВыбранныеФайлы, ДополнительныеПараметры);

КонецПроцедуры


&НаКлиенте
//И я выгружаю в файл  'ПутьКФайлу'
//@ИЯВыгружаюВФайл(Параметр1)
Процедура ЯВыгружаюВФайл(ПутьКФайлу) Экспорт      
	
	// Создаем массив файлов для совместимости с функцией ВыгрузитьПеременныеЗавершение
	ВыбранныеФайлы = Новый Массив;
	ВыбранныеФайлы.Добавить(ПутьКФайлу);
	
	// Создаем пустую структуру для дополнительных параметров
	ДополнительныеПараметры = Новый Структура;
	
	Ванесса.ВыгрузитьПеременныеЗавершение(ВыбранныеФайлы, ДополнительныеПараметры);

КонецПроцедуры






	
&НаСервере
Функция ЗагрузитьИзСистемыОткатаНаСервере(ИмяЗакладки) Экспорт      
	
	// Проверка доступности системы отката
	Если НЕ ПроверитьДоступностьСистемыОтката() Тогда
		Сообщить("Система отката недоступна. Требуется расширение 'ОткатИзмененийДанных' версии 1.0.0.4 или выше.");
		Возврат Неопределено;
	КонецЕсли;
	
	РезультатПоиска = НайтиПоследнююЗаписьПоИмениЗакладки(ИмяЗакладки);
    
    Если РезультатПоиска.Количество() > 0 Тогда
		Возврат РезультатПоиска[0];
	Иначе
        Сообщить("Записи по наименованию '" + ИмяЗакладки + "' не найдены.");
        Возврат Неопределено;
    КонецЕсли;
	
КонецФункции
	
	



&НаСервере
Процедура УдалитьПоследнююЗаписьВХранилищеКонтекстов(Наименование)
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ ПЕРВЫЕ 1
        |    ХранилищеКонтекстов.Период 
		|ИЗ
        |    РегистрСведений.ХранилищеКонтекстов КАК ХранилищеКонтекстов
        |ГДЕ
        |    ХранилищеКонтекстов.Наименование = &Наименование
        |
        |УПОРЯДОЧИТЬ ПО
        |    ХранилищеКонтекстов.Период УБЫВ";
        
    Запрос.УстановитьПараметр("Наименование", Наименование);
    
    Выборка = Запрос.Выполнить().Выбрать();
    
    Если Выборка.Следующий() Тогда
        
        МенеджерЗаписи = РегистрыСведений.ХранилищеКонтекстов.СоздатьМенеджерЗаписи();
        
        МенеджерЗаписи.Наименование = Наименование;
        МенеджерЗаписи.Период       = Выборка.Период;         
       
        Попытка
            МенеджерЗаписи.Удалить();
        Исключение
            Сообщить("Ошибка удаления записи: " + ОписаниеОшибки());
        КонецПопытки;
        
    Иначе
        Сообщить("Запись с наименованием '" + Наименование + "' не найдена.");
    КонецЕсли;
    
КонецПроцедуры 

 

&НаСервере
Функция НайтиПоследнююЗаписьПоИмениЗакладки(ИмяЗакладки)
    
    лТекст = "
        |ВЫБРАТЬ ПЕРВЫЕ 1
        |    ХранилищеКонтекстов.Наименование КАК Наименование,
        |    ХранилищеКонтекстов.Период КАК Период
        |ИЗ
        |    РегистрСведений.ХранилищеКонтекстов КАК ХранилищеКонтекстов
        |ГДЕ
        |    ХранилищеКонтекстов.Наименование = &Наименование
        |
        |УПОРЯДОЧИТЬ ПО
        |    Период УБЫВ
        |";

    лЗапрос = Новый Запрос(лТекст);

    лЗапрос.УстановитьПараметр("Наименование", ИмяЗакладки);

    лВыборка = лЗапрос.Выполнить().Выбрать();
    
    лРезультат = Новый Массив;
    Пока лВыборка.Следующий() Цикл
        лСтруктура = Новый Структура;
        лСтруктура.Вставить("Наименование", лВыборка.Наименование);
        лСтруктура.Вставить("Период", лВыборка.Период);
        лРезультат.Добавить(лСтруктура);
    КонецЦикла;
    
    // Возврат результата как массив структур
    Возврат лРезультат;

КонецФункции // НайтиПоследнююЗаписьПоИмениЗакладки

&НаСервере
Функция ПроверитьДоступностьСистемыОтката()
    
    ДоступностьКнопокОтката = Ложь;
	
		
	
    Для Каждого РасширениеКонфигурации Из РасширенияКонфигурации.Получить() Цикл    
        Если РасширениеКонфигурации.Имя = "ОткатИзмененийДанных" Тогда
            РезультатСравнения = СравнитьВерсии(РасширениеКонфигурации.Версия, "1.0.0.4");
            Если РезультатСравнения >= 0 Тогда 
                ДоступностьКнопокОтката = Истина;
                Прервать;
            КонецЕсли;
        КонецЕсли;
    КонецЦикла;  
    
    Возврат ДоступностьКнопокОтката;

КонецФункции
 
&НаСервереБезКонтекста
Функция СравнитьВерсии(Версия1, Версия2)

    МассивВерсии1 = РазделитьСтроку(Версия1, ".");
    МассивВерсии2 = РазделитьСтроку(Версия2, ".");

    МаксДлина = Макс(МассивВерсии1.Количество(), МассивВерсии2.Количество());

    Для i = 0 По МаксДлина - 1 Цикл

        Число1 = 0;
        Если i < МассивВерсии1.Количество() Тогда
            Попытка
                Число1 = Число(МассивВерсии1[i]);
            Исключение
            КонецПопытки;
        КонецЕсли;

        Число2 = 0;
        Если i < МассивВерсии2.Количество() Тогда
            Попытка
                Число2 = Число(МассивВерсии2[i]);
            Исключение
            КонецПопытки;
        КонецЕсли;

        Если Число1 > Число2 Тогда
            Возврат 1; // Версия1 > Версия2
        ИначеЕсли Число1 < Число2 Тогда
            Возврат -1; // Версия1 < Версия2
        КонецЕсли;

    КонецЦикла;

    // Версии равны
    Возврат 0;

КонецФункции

&НаСервереБезКонтекста
Функция РазделитьСтроку(Строка, Разделитель)
    
    Результат = Новый Массив;
    
    Если Строка = "" Тогда
        Возврат Результат;
    КонецЕсли;
    
    Позиция = 1;
    ДлинаРазделителя = СтрДлина(Разделитель);
    
    Пока Позиция <= СтрДлина(Строка) Цикл
        СледующаяПозиция = НайтиВСтроке(Строка, Разделитель, Позиция);
        Если СледующаяПозиция > 0 Тогда
            Элемент = Сред(Строка, Позиция, СледующаяПозиция - Позиция);
            Результат.Добавить(Элемент);
            Позиция = СледующаяПозиция + ДлинаРазделителя;
        Иначе
            Элемент = Сред(Строка, Позиция);
            Результат.Добавить(Элемент);
            Позиция = СтрДлина(Строка) + 1;
        КонецЕсли;
    КонецЦикла;
    
    Возврат Результат;

КонецФункции

&НаСервереБезКонтекста
Функция НайтиВСтроке(Строка, Подстрока, НачальнаяПозиция)
    
    ДлинаСтроки = СтрДлина(Строка);
    ДлинаПодстроки = СтрДлина(Подстрока);
    
    Если ДлинаПодстроки = 0 Тогда
        Возврат НачальнаяПозиция;
    КонецЕсли;
    
    Для i = НачальнаяПозиция По ДлинаСтроки - ДлинаПодстроки + 1 Цикл
        Если Сред(Строка, i, ДлинаПодстроки) = Подстрока Тогда
            Возврат i;
        КонецЕсли;
    КонецЦикла;
    
    Возврат 0;

КонецФункции



